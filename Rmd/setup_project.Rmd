---
title: "Setup Project"
author: "Sebastian DiGeronimo"
date: "2022-11-22"
output: html_document
---

# Step 1: Load/install most used packages 
```{r setup, include=FALSE}
library("ggplot2")
library("tibble")
library("tidyr")
library("readr")
library("purrr")
library("dplyr")
library("stringr")
library("forcats")
library("lubridate")
library("glue")
library("fs")
library("magrittr")
library("here")
```

# Step 2: Source scripts with functions needed and attach to search path

1. Creates directory for consistent file structures

2. Copy files from designated location
    - The first time using, this will open a `.Rprofile` file. This will be used to create a variable called `box_dir`. This is where the raw abundance directory is. If you want to select through popup set `copy_files_box(.choose = TRUE)` and will paste to console. You can then copy and paste it into the .Rprofile. You will then need to re-source the chunk.
    - If you want to auto-look for new files, copy and paste the chunck `funcs` into the `.Rprofile` and each `Restart` in R will look for new files and ask if you want to download. 
        - You can either:
            1. `ask` = `TRUE` for asking if you want to copy and which ones
            2. `auto` = `TRUE` to copy any file that is new

3. Load functions for searching the raw for taxa names and connecting it to a master sheet
- if a master sheet doesn't exists locally, it will start a new one and put it in:
    - `data/metadata/aphia_id`

```{r}
# box_dir = "C:/Users/spd19/Box/IMaRS Zooplankton data/"

# # source scripts with functions in new environment
# my_funcs <- new.env()
# 
# # create directory structure if does not exists and create tree map
# source(here::here("scripts","create_dir.R"), local = my_funcs)
# # copy files from box
# source(here::here("scripts", "copy_files_from_box.R"), local = my_funcs)
# # loading check for taxa
# source(here::here("scripts", "taxa_list_check.R"), local = my_funcs)
# 
# 
# attach(my_funcs)
# rm(my_funcs)
# 
# copy_files_box(ask = TRUE)

prof <- here(".Rprofile")
pkgs <- paste(
    "librarian::shelf(
    librarian, ggplot2, tibble, tidyr, readr, purrr, dplyr, stringr,
    forcats, lubridate, glue, fs, magrittr, here,
    # broom # optional,
    
    quiet = TRUE
) # end")


if (!file_exists(prof)) {
    usethis::edit_r_profile("project")
    # cat(character(0), file = prof, append = FALSE)
    
    cat(c(pkgs, "\n"), file = prof, append = TRUE)
}

# check packages 
if (file.exists(prof)) {
    line1 <- readLines(prof)
    strt <- grep("librarian::shelf\\(", line1)
    ends <- grep("\\) # end", line1)
    
    if (identical(strt, integer(0))) {
        cat(c(pkgs, "\n"), file = prof, append = TRUE)
        strt <- grep("librarian::shelf\\(", line1)
        ends <- grep("\\) # end", line1)
        }

    rng <- NULL
    for (i in seq_along(strt)) {
        rng <- c(rng, strt[i]:ends[i])
    }
    packs <- line1[rng]
}

```

```{r funcs}
funcs <- paste(
'\n# source scripts with functions in new environment
my_funcs <- new.env()

# create directory structure if does not exists and create tree map
source(here("scripts","create_dir.R"), local = my_funcs)
# copy files from box
source(here("scripts", "copy_files_from_box.R"), local = my_funcs)
# loading check for taxa
source(here("scripts", "taxa_list_check.R"), local = my_funcs)


attach(my_funcs)
rm(my_funcs)

copy_files_box(ask = TRUE)')

if (file.exists(prof)) {
    strt <- grep("# source scripts with functions in new environment", line1)
    ends <- grep("copy_files_box", line1)
    
    if (identical(strt, integer(0))) {
        cat(c(funcs, "\n"), file = prof, append = TRUE)
    }
    
}

```
