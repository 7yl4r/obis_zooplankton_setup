---
title: "Taxonomix Matchup to WoRMs"
author: "Sebastian DiGeronimo"
date: "3/2/2022"
output: html_document
---

```{r setup, include=FALSE}
root <- rprojroot::find_rstudio_root_file()
knitr::opts_chunk$set(echo = TRUE)
library("readxl")
library("hablar") # might be useful when needing to fix names
library("worrms")

library("tidyverse")
library("ggplot2")
library("ggforce")
library("tibble")
library("tidyr")
library("readr")
library("purrr")
library("dplyr")
library("stringr")
library("forcats")
library("lubridate")
library("glue")
library("fs")
library("geosphere")
library("vroom")
library("plotly")
library("magrittr")

```

```{r create-dir}
# will create a set directory if does not exists
# useful for new projects

subDir <-
    c("/data/raw",
      "/data/processed",
      "/data/plots",
      "/data/metadata",
      "/Rmd",
      "/scripts")

fs::dir_create(path = paste0(root,"/",subDir))
rm(subDir)
```

```{r load-taxa-data}
file.dir <- paste0(root,"/data")

file.taxa <- fs::dir_ls(path =  paste0(root,"/data"),
           regexp = "^[^~]*Analysis.*\\.xlsx$")


skips <-  which(readxl::read_xlsx(file.taxa[2], range = cell_cols("A"), col_names = FALSE )=="Taxa") - 1

calc <- readxl::read_xlsx(file.taxa[1], n_max = skips-1, col_names = F, .name_repair = janitor::make_clean_names) %>%
    pivot_wider(id_col = x, names_from = x, values_from = x_2 ) %>% 
    janitor::clean_names() %>%
    mutate(
    date_collected = as.Date(as.numeric(date_collected),origin = "1899-12-30"),
    date_analyzed = as.Date(as.numeric(date_analyzed),origin = "1899-12-30")
    )

taxa <- readxl::read_xlsx(file.taxa[2],  skip = skips, .name_repair = janitor::make_clean_names)


taxa <- readxl::read_xlsx(file.taxa[2],  sheet = 2, .name_repair = janitor::make_clean_names) %>%
    rename(taxa = copepods)

# clean up columns
taxa.name <-
    taxa  %>% #%$% as.vector(Taxa)
    # select(1,2) %>%
    select(1) %>%
    rename(taxa_orig = taxa) %>%
    mutate(
        taxa = str_remove(taxa_orig, regex(
            "sp{0,2}\\.|\\(unknown\\)", ignore_case = T
        )),
        lifeStage = str_extract_all(
            taxa,
            regex(
                "copepodite|nauplii|larvae|juvenile|eggs|egg|zoea|protozoea|cypris|megalopa",
                ignore_case = T
            ),
            simplify = T
        )  %>%
            str_to_lower(),
        taxa = str_remove(
            taxa,
            regex(
                "copepodite|nauplii|larvae|juvenile|adult|eggs|zoea|protozoea|cypris|megalopa",
                ignore_case = T
            )
        )
    ) 

# taxa.name$lifeStage
rm(skips, file.taxa)
```

1. read in new occurence file
2. read the first 10 rows and transpose to longer
3. determine if the identified species are in the master aphia taxa list, or 
    if need to rerun taxa_match_fix
4. row bind occurrence data with taxa info


```{r}
source(paste0(root,"/scripts/match_taxa_fix.R"))

# taxa_file <- fs::file_exists("../data/metadata/aphia_taxa.csv")

taxa_file <-  fs::dir_ls(path =  paste0(root,"/data/metadata/"),
           regexp = "aphia_taxa\\.csv$")

if (is_empty(taxa_file)){
taxalist <- match_taxa_fix(taxa.name$taxa, fuzzy = TRUE, ask = T)

taxa_matched <- bind_cols(taxa.name, taxalist)

write_csv(taxa_matched, paste0(root,"/data/metadata/aphia_taxa",  format(Sys.time(), '_%Y%m%d_%H%M%S'),".csv"))
}

taxa_matched <-  readr::read_csv(taxa_file)

# if some taxa have NA names, can try again on this subset
taxa_ntmtch <- taxa_matched %>%
    filter(is.na(scientificName)) %>%
    select(1:3)

if (nrow(taxa_ntmtch) > 0) {
    taxa_new <- match_taxa_fix(taxa_ntmtch$taxa, fuzzy = TRUE, ask = T)
    
    taxa_mtchnew <- bind_cols(taxa_ntmtch, taxa_new)
    taxa_matched <-
        bind_rows(taxa_matched, taxa_mtchnew)
    
    write_csv(taxa_matched,
              paste0(
                  root,
                  "/data/metadata/aphia_taxa",
                  format(Sys.time(), '_%Y%m%d_%H%M%S'),
                  ".csv"
              ))
}

```

# tried a different database without working
```{r}
library("taxize")



cbind(taxa.name, test)

?get_tsn
get_tsn(taxa.name[1:5])
get_tsn(("Acartia"))
get_wormsid(test)
get_wormsid("fish", searchtype = 'common')

rgbif::name_backbone("Acartia")

obistools::match_taxa(c("Acartia","Candacia","copepod","Euterpina acuntifrons"), ask = T)
```

```{r}


obis.taxa <- obistools::match_taxa(taxa.name, ask = T)

robis::taxon(11676)

# with this 20 have NA without ability to ask for input
obis.taxa %>%
    mutate(taxa.name, .before = 1)
```
## This was used to edit  the `function match_taxa_fix`
